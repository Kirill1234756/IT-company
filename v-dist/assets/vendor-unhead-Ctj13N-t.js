const $=new Set(["title","titleTemplate","script","style","noscript"]),A=new Set(["base","meta","link","style","script","noscript"]),D=new Set(["title","titleTemplate","templateParams","base","htmlAttrs","bodyAttrs","meta","link","style","script","noscript"]),j=new Set(["base","title","titleTemplate","bodyAttrs","htmlAttrs","templateParams"]),L=new Set(["tagPosition","tagPriority","tagDuplicateStrategy","children","innerHTML","textContent","processTemplateParams"]),J=typeof window<"u";function V(e){return e}function M(e){let t=9;for(let n=0;n<e.length;)t=Math.imul(t^e.charCodeAt(n++),9**9);return((t^t>>>9)+65536).toString(16).substring(1,8).toLowerCase()}function v(e){if(e._h)return e._h;if(e._d)return M(e._d);let t=`${e.tag}:${e.textContent||e.innerHTML||""}:`;for(const n in e.props)t+=`${n}:${String(e.props[n])},`;return M(t)}function R(e,t){return e instanceof Promise?e.then(t):t(e)}function H(e,t,n,s){const o=s||E(typeof t=="object"&&typeof t!="function"&&!(t instanceof Promise)?{...t}:{[e==="script"||e==="noscript"||e==="style"?"innerHTML":"textContent"]:t},e==="templateParams"||e==="titleTemplate");if(o instanceof Promise)return o.then(i=>H(e,t,n,i));const r={tag:e,props:o};for(const i of L){const d=r.props[i]!==void 0?r.props[i]:n[i];d!==void 0&&((!(i==="innerHTML"||i==="textContent"||i==="children")||$.has(r.tag))&&(r[i==="children"?"innerHTML":i]=d),delete r.props[i])}return r.props.body&&(r.tagPosition="bodyClose",delete r.props.body),r.tag==="script"&&typeof r.innerHTML=="object"&&(r.innerHTML=JSON.stringify(r.innerHTML),r.props.type=r.props.type||"application/json"),Array.isArray(r.props.content)?r.props.content.map(i=>({...r,props:{...r.props,content:i}})):r}function U(e,t){var s;const n=e==="class"?" ":";";return t&&typeof t=="object"&&!Array.isArray(t)&&(t=Object.entries(t).filter(([,o])=>o).map(([o,r])=>e==="style"?`${o}:${r}`:o)),(s=String(Array.isArray(t)?t.join(n):t))==null?void 0:s.split(n).filter(o=>!!o.trim()).join(n)}function O(e,t,n,s){for(let o=s;o<n.length;o+=1){const r=n[o];if(r==="class"||r==="style"){e[r]=U(r,e[r]);continue}if(e[r]instanceof Promise)return e[r].then(i=>(e[r]=i,O(e,t,n,o)));if(!t&&!L.has(r)){const i=String(e[r]),d=r.startsWith("data-");i==="true"||i===""?e[r]=d?"true":!0:e[r]||(d&&i==="false"?e[r]="false":delete e[r])}}}function E(e,t=!1){const n=O(e,t,Object.keys(e),0);return n instanceof Promise?n.then(()=>e):e}const I=10;function k(e,t,n){for(let s=n;s<t.length;s+=1){const o=t[s];if(o instanceof Promise)return o.then(r=>(t[s]=r,k(e,t,s)));Array.isArray(o)?e.push(...o):e.push(o)}}function F(e){const t=[],n=e.resolvedInput;for(const o in n){if(!Object.prototype.hasOwnProperty.call(n,o))continue;const r=n[o];if(!(r===void 0||!D.has(o))){if(Array.isArray(r)){for(const i of r)t.push(H(o,i,e));continue}t.push(H(o,r,e))}}if(t.length===0)return[];const s=[];return R(k(s,t,0),()=>s.map((o,r)=>(o._e=e._i,e.mode&&(o._m=e.mode),o._p=(e._i<<I)+r,o)))}const z=new Set(["onload","onerror","onabort","onprogress","onloadstart"]),_={base:-10,title:10},x={critical:-80,high:-10,low:20};function Q(e){const t=e.tagPriority;if(typeof t=="number")return t;let n=100;return e.tag==="meta"?e.props["http-equiv"]==="content-security-policy"?n=-30:e.props.charset?n=-20:e.props.name==="viewport"&&(n=-15):e.tag==="link"&&e.props.rel==="preconnect"?n=20:e.tag in _&&(n=_[e.tag]),t&&t in x?n+x[t]:n}const X=[{prefix:"before:",offset:-1},{prefix:"after:",offset:1}],W=["name","property","http-equiv"];function K(e){const{props:t,tag:n}=e;if(j.has(n))return n;if(n==="link"&&t.rel==="canonical")return"canonical";if(t.charset)return"charset";if(t.id)return`${n}:id:${t.id}`;for(const s of W)if(t[s]!==void 0)return`${n}:${s}:${t[s]}`;return!1}const h="%separator";function q(e,t,n=!1){var o;let s;if(t==="s"||t==="pageTitle")s=e.pageTitle;else if(t.includes(".")){const r=t.indexOf(".");s=(o=e[t.substring(0,r)])==null?void 0:o[t.substring(r+1)]}else s=e[t];if(s!==void 0)return n?(s||"").replace(/"/g,'\\"'):s||""}const B=new RegExp(`${h}(?:\\s*${h})*`,"g");function Y(e,t,n,s=!1){if(typeof e!="string"||!e.includes("%"))return e;let o=e;try{o=decodeURI(e)}catch{}const r=o.match(/%\w+(?:\.\w+)?/g);if(!r)return e;const i=e.includes(h);return e=e.replace(/%\w+(?:\.\w+)?/g,d=>{if(d===h||!r.includes(d))return d;const g=q(t,d.slice(1),s);return g!==void 0?g:d}).trim(),i&&(e.endsWith(h)&&(e=e.slice(0,-h.length)),e.startsWith(h)&&(e=e.slice(h.length)),e=e.replace(B,n).trim()),e}function Z(e,t){return e==null?t||null:typeof e=="function"?e(t):e}async function G(e,t={}){const n=t.document||e.resolvedOptions.document;if(!n||!e.dirty)return;const s={shouldRender:!0,tags:[]};if(await e.hooks.callHook("dom:beforeRender",s),!!s.shouldRender)return e._domUpdatePromise||(e._domUpdatePromise=new Promise(async o=>{var C;const r=(await e.resolveTags()).map(c=>({tag:c,id:A.has(c.tag)?v(c):c.tag,shouldRender:!0}));let i=e._dom;if(!i){i={elMap:{htmlAttrs:n.documentElement,bodyAttrs:n.body}};const c=new Set;for(const a of["body","head"]){const f=(C=n[a])==null?void 0:C.children;for(const u of f){const l=u.tagName.toLowerCase();if(!A.has(l))continue;const y={tag:l,props:await E(u.getAttributeNames().reduce((T,w)=>({...T,[w]:u.getAttribute(w)}),{})),innerHTML:u.innerHTML},b=K(y);let p=b,P=1;for(;p&&c.has(p);)p=`${b}:${P++}`;p&&(y._d=p,c.add(p)),i.elMap[u.getAttribute("data-hid")||v(y)]=u}}}i.pendingSideEffects={...i.sideEffects},i.sideEffects={};function d(c,a,f){const u=`${c}:${a}`;i.sideEffects[u]=f,delete i.pendingSideEffects[u]}function g({id:c,$el:a,tag:f}){const u=f.tag.endsWith("Attrs");if(i.elMap[c]=a,u||(f.textContent&&f.textContent!==a.textContent&&(a.textContent=f.textContent),f.innerHTML&&f.innerHTML!==a.innerHTML&&(a.innerHTML=f.innerHTML),d(c,"el",()=>{var l;(l=i.elMap[c])==null||l.remove(),delete i.elMap[c]})),f._eventHandlers)for(const l in f._eventHandlers)Object.prototype.hasOwnProperty.call(f._eventHandlers,l)&&a.getAttribute(`data-${l}`)!==""&&((f.tag==="bodyAttrs"?n.defaultView:a).addEventListener(l.substring(2),f._eventHandlers[l].bind(a)),a.setAttribute(`data-${l}`,""));for(const l in f.props){if(!Object.prototype.hasOwnProperty.call(f.props,l))continue;const y=f.props[l],b=`attr:${l}`;if(l==="class"){if(!y)continue;for(const p of y.split(" "))u&&d(c,`${b}:${p}`,()=>a.classList.remove(p)),!a.classList.contains(p)&&a.classList.add(p)}else if(l==="style"){if(!y)continue;for(const p of y.split(";")){const P=p.indexOf(":"),T=p.substring(0,P).trim(),w=p.substring(P+1).trim();d(c,`${b}:${T}`,()=>{a.style.removeProperty(T)}),a.style.setProperty(T,w)}}else a.getAttribute(l)!==y&&a.setAttribute(l,y===!0?"":String(y)),u&&d(c,b,()=>a.removeAttribute(l))}}const S=[],m={bodyClose:void 0,bodyOpen:void 0,head:void 0};for(const c of r){const{tag:a,shouldRender:f,id:u}=c;if(f){if(a.tag==="title"){n.title=a.textContent;continue}c.$el=c.$el||i.elMap[u],c.$el?g(c):A.has(a.tag)&&S.push(c)}}for(const c of S){const a=c.tag.tagPosition||"head";c.$el=n.createElement(c.tag.tag),g(c),m[a]=m[a]||n.createDocumentFragment(),m[a].appendChild(c.$el)}for(const c of r)await e.hooks.callHook("dom:renderTag",c,n,d);m.head&&n.head.appendChild(m.head),m.bodyOpen&&n.body.insertBefore(m.bodyOpen,n.body.firstChild),m.bodyClose&&n.body.appendChild(m.bodyClose);for(const c in i.pendingSideEffects)i.pendingSideEffects[c]();e._dom=i,await e.hooks.callHook("dom:rendered",{renders:r}),o()}).finally(()=>{e._domUpdatePromise=void 0,e.dirty=!1})),e._domUpdatePromise}function N(e,t={}){const n=t.delayFn||(s=>setTimeout(s,10));return e._domDebouncedUpdatePromise=e._domDebouncedUpdatePromise||new Promise(s=>n(()=>G(e,t).then(()=>{delete e._domDebouncedUpdatePromise,s()})))}function ee(e){return t=>{var s,o;const n=((o=(s=t.resolvedOptions.document)==null?void 0:s.head.querySelector('script[id="unhead:payload"]'))==null?void 0:o.innerHTML)||!1;return n&&t.push(JSON.parse(n)),{mode:"client",hooks:{"entries:updated":r=>{N(r,e)}}}}}export{ee as D,A as H,J as I,z as N,X as S,K as a,M as b,V as d,v as h,F as n,Y as p,Z as r,Q as t};
